<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>å¡”ç¾…å åœ (è³‡æ–™åº«æ•´åˆç‰ˆ)</title>
    <style>
	.controls {
            position: absolute;
            bottom: 40px;
            z-index: 200;
            display: flex; /* é›»è…¦ç‰ˆç¶­æŒä¸€æ’ */
            gap: 20px;
            background: rgba(0,0,0,0.5);
            padding: 15px;
            border-radius: 50px;
        }
        :root {
            --card-w: 120px;
            --card-h: 210px;
        }

        body { 
            font-family: 'Helvetica', sans-serif; 
            background: radial-gradient(circle at center, #1a1a1a, #000); 
            color: white; 
            margin: 0; 
            
            /* â˜…â˜…â˜… ä¿®æ”¹ï¼šæ”¹ç”¨ dvh (å‹•æ…‹è¦–çª—é«˜åº¦)ï¼Œè§£æ±ºæ‰‹æ©Ÿç¶²å€åˆ—é®æ“‹å•é¡Œ â˜…â˜…â˜… */
            height: 100dvh; 
            
            overflow: hidden; 
            display: flex;
            flex-direction: column;
            align-items: center;

            /* â˜…â˜…â˜… æ–°å¢ï¼šç¦æ­¢æ‰‹æŒ‡è§¸æ§ç¸®æ”¾è¡Œç‚º â˜…â˜…â˜… */
            touch-action: pan-x pan-y; 
            
            /* â˜…â˜…â˜… æ–°å¢ï¼šé˜²æ­¢æ‰‹æ©Ÿæ©«ç›´å‘åˆ‡æ›æ™‚æ–‡å­—å¿½å¤§å¿½å° â˜…â˜…â˜… */
            -webkit-text-size-adjust: 100%;
            text-size-adjust: 100%;
        }
.modal-card-img-container {
    text-align: center;
    padding-bottom: 20px;
    margin-top: 20px;
    border-top: 1px solid #333; /* åŠ ä¸€æ¢åˆ†éš”ç·š */
}

.card.selected {
    box-shadow: 0 0 15px #f1c40f, 0 0 30px #f1c40f !important;
    border-color: #fff;
    z-index: 1000 !important;
}

.modal-card-img {
    width: 150px; /* è¨­å®šé©ç•¶å¯¬åº¦ */
    max-width: 70%;
    height: auto;
    border-radius: 10px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.5);
    border: 2px solid #d4af37;
    transition: transform 0.3s; /* æ—‹è½‰æ™‚æœ‰å‹•ç•« */
    margin-top: 10px;
}
.nav-btn {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(0, 0, 0, 0.6);
    color: #d4af37;
    border: 1px solid #d4af37;
    font-size: 24px;
    padding: 10px 15px;
    cursor: pointer;
    z-index: 2001; /* ç¢ºä¿åœ¨æœ€ä¸Šå±¤ */
    border-radius: 50%;
    transition: 0.3s;
    outline: none;
}
.nav-btn:hover {
    background: #d4af37;
    color: #000;
}
.nav-btn.prev { left: 10px; }
.nav-btn.next { right: 10px; }

/* å¦‚æœæ˜¯æ‰‹æ©Ÿç‰ˆï¼ŒæŒ‰éˆ•ç¨å¾®å°ä¸€é»ï¼Œé¿å…é®æ“‹å…§å®¹ */
@media (max-width: 600px) {
    .nav-btn {
        padding: 5px 10px;
        font-size: 18px;
        background: rgba(0,0,0,0.8);
    }
}
select {
    /* ...åŸæœ‰è¨­å®š... */
    min-width: 110px; /* ç¢ºä¿æœ‰æœ€å°å¯¬åº¦ */
    text-align: center;
}

/* é‡å°é¸å–®é è¨­é¸é … (disabled) çš„é¡è‰²èª¿æ•´ */
select option[disabled] {
    color: #888;
    font-weight: bold;
    background: #111;
}

            @media (max-width: 600px) {
            :root {
                --card-w: 80px; 
                --card-h: 140px;
            }

            .controls {
                bottom: 0; /* è²¼åº• */
                padding: 15px 15px 30px 15px; /* åº•éƒ¨ç•™ç™½çµ¦ iPhone é»‘æ¢ */
                width: 100%;
                border-radius: 20px 20px 0 0;
                gap: 10px;
                background: rgba(0,0,0,0.9);
                box-sizing: border-box; 
                
                /* â˜… é—œéµä¿®æ”¹ï¼šå¼·åˆ¶æ”¹ç”¨ Grid ç¶²æ ¼ */
                display: grid; 
                grid-template-columns: 1fr 1fr; /* åˆ†å…©æ¬„ */
                grid-template-rows: auto auto auto; /* è‡ªå‹•ä¸‰è¡Œ */
                left: 0; 
            }

            /* ç¬¬ä¸€è¡Œï¼šç¶œåˆé‹å‹¢ (è·¨å…©æ¬„) */
            #categorySelector {
                grid-column: 1 / -1; 
                width: 100%;
            }

            /* ç¬¬äºŒè¡Œï¼šåŸºç¤ èˆ‡ é€²éš (å„ä½”ä¸€æ¬„) */
            #spreadBasic, #spreadAdv {
                width: 100%;
                font-size: 13px;
                padding: 10px 5px;
            }

            /* ç¬¬ä¸‰è¡Œï¼šæŒ‰éˆ• (æ˜ç¢ºæŒ‡å®šå„ä½”ä¸€æ ¼) */
            #btnShuffle, #btnSpread {
                width: 100%;
                padding: 12px 0;
                font-size: 16px;
                grid-column: span 1; 
            }
            
            /* é‡ç½®æŒ‰éˆ• */
            #btnReset {
                grid-column: 1 / -1;
                width: 100%;
                padding: 12px;
            }
        }

        /* --- æ¡Œé¢å€åŸŸ --- */
        .table-area {
            position: relative;
            width: 100%;
            height: 100%;
            perspective: 1200px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* --- å¡ç‰‡æœ¬é«” --- */
        .card {
            width: var(--card-w);
            height: var(--card-h);
            position: absolute;
            transform-style: preserve-3d;
            left: 50%;
            top: 50%;
            margin-left: calc(var(--card-w) / -2);
            margin-top: calc(var(--card-h) / -2);
            transform: translate(var(--tx), var(--ty)) rotate(var(--rot));
            transition: transform 0.5s cubic-bezier(0.25, 0.8, 0.25, 1);
            cursor: pointer;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }

        /* æ‰‡å½¢å±•é–‹ç‰¹æ•ˆ */
        .card.spread:hover {
            z-index: 999 !important;
            transform: translate(var(--tx), var(--ty)) rotate(var(--rot)) translateY(-40px) scale(1.1);
            box-shadow: 0 15px 30px rgba(0,0,0,0.8);
            transition: transform 0.2s ease-out; 
        }
        .card.spread { box-shadow: -5px 0 10px rgba(0,0,0,0.3); }

        .card-inner {
            width: 100%; height: 100%; position: relative;
            transform-style: preserve-3d; transition: transform 0.8s;
        }
        .card.flipped .card-inner { transform: rotateY(180deg); }

        .front, .back {
            position: absolute; width: 100%; height: 100%;
            backface-visibility: hidden; border-radius: 10px; overflow: hidden;
        }

        .front {
    /* 1. è¨­å®šèƒŒæ™¯åœ–ç‰‡ */
    background-image: url('images/back.jpg'); 
    
    /* 2. ç¢ºä¿åœ–ç‰‡å¡«æ»¿ä¸”ä¸é‡è¤‡ */
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;

    /* 3. é‚Šæ¡†é¡è‰²å¯ä»¥èª¿æ•´æˆè·Ÿåœ–ç‰‡é‡‘è‰²ä¸€è‡´ */
    border: 2px solid #d4af37; 
    
    /* 4. åŠ ä¸€é»å…§é™°å½±å¢åŠ ç«‹é«”æ„Ÿ */
    box-shadow: inset 0 0 10px rgba(0,0,0,0.8);
}
        .back {
            background: #fff; transform: rotateY(180deg);
            display: flex; flex-direction: column;
        }
        
        .back-img-container { flex: 1; width: 100%; overflow: hidden; position: relative; }
        .back img { width: 100%; height: 100%; object-fit: fill; }
        
	.back-text {
 	   padding: 4px 2px; /* æ¸›å°‘å…§è· */
	}

	/* ä¸Šæ–¹çš„ã€Œä½ç½®åç¨±ã€(å¦‚ï¼šéå»ã€ç¾åœ¨) */
	.back-text div:first-child {
 	   font-size: 10px !important; /* åŸæœ¬å¯èƒ½æ¯”è¼ƒå¤§ï¼Œå¼·åˆ¶ç¸®å° */
  	  margin-bottom: 1px !important;
  	  opacity: 0.9;
	}

/* ä¸‹æ–¹çš„ã€Œç‰Œå¡åç¨±ã€(å¦‚ï¼šæ„šè€…) */
.card-name-text {
    font-size: 10px !important; /* è¨­å®šç‚º 11px æˆ– 12px */
    font-weight: bold;
    line-height: 1.2;
    text-overflow: ellipsis; /* è¶…å‡ºéƒ¨åˆ†è®Š... */
}
        
/* ä¿®æ”¹å¾Œçš„ .card.drawn */
.card.drawn {
    /* 1. é—œéµä¿®æ­£ï¼šå–æ¶ˆåŸæœ¬ CSS çš„ç½®ä¸­åç§»ï¼Œäº¤çµ¦ JS æ§åˆ¶ */
    margin: 0 !important; 
    
    /* 2. ç¢ºä¿å®šä½åŸºæº–é»åœ¨æ­£ä¸­é–“ */
    top: 50%;
    left: 50%;

    /* 3. ä¿ç•™éæ¸¡å‹•ç•« */
    transition: transform 0.6s cubic-bezier(0.25, 0.8, 0.25, 1);
}

/* â˜…â˜…â˜… é—œéµè¨­å®šï¼šæ»‘é¼ æ‡¸åœ (Hover) æ•ˆæœ â˜…â˜…â˜… */
.card.drawn:hover {
    /* 1. å±¤ç´šè®Šæœ€é«˜ï¼šç¢ºä¿è¢«è“‹ä½çš„ç‰Œæœƒç¬é–“è·‘åˆ°æœ€ä¸Šé¢ */
    z-index: 9999 !important; 
    
    /* 2. è¦–è¦ºæ‡¸æµ®æ„Ÿï¼šåŠ æ·±é™°å½±ï¼Œè®“å®ƒçœ‹èµ·ä¾†é›¢èƒŒæ™¯æ›´é  */
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.7) !important;
    
    /* 3. ç¨å¾®æ‰“äº®ï¼šè®“é¸ä¸­çš„ç‰Œçœ‹èµ·ä¾†ç™¼å…‰ */
    filter: brightness(1.1);
    
    /* 4. æ»‘é¼ æ¸¸æ¨™è®Šæ‰‹å‹ */
    cursor: pointer;
}
/* æ–°å¢ï¼šä¸‹æ‹‰é¸å–®æ¨£å¼ */
        select {
            padding: 10px 30px 10px 15px; /* å³é‚Šç•™å¤šä¸€é»ç©ºé–“çµ¦ç®­é ­ */
            font-size: 16px;
            cursor: pointer;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #d4af37;
            color: #d4af37;
            border-radius: 8px;
            outline: none;
            text-align: center;
            text-align-last: center;
            
            /* â˜… é—œéµä¿®æ­£ï¼šä¿ç•™æ‰‹æ©ŸåŸç”Ÿçš„ä¸‹æ‹‰é¸å–®ç®­é ­ï¼Œä¸ç„¶æœƒçœ‹èµ·ä¾†åƒæ²’åæ‡‰ â˜… */
            appearance: menulist; 
            -webkit-appearance: menulist;
        }
select:hover {
    background: #d4af37;
    color: #000;
}
option {
    background: #000;
    color: #d4af37;
}

@media (max-width: 600px) {
    select {
        max-width: 100px; /* æ‰‹æ©Ÿç‰ˆé¸å–®ä¸è¦å¤ªå¯¬ */
        font-size: 12px;
    }
}

        /* --- Modal é€²éšæ¨£å¼ --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 2000;
            display: none; justify-content: center; align-items: center;
            opacity: 0; transition: opacity 0.3s;
        }
        .modal-content {
            background: #1a1a1a; border: 2px solid #d4af37; color: #fff;
            padding: 0; width: 90%; max-width: 550px; border-radius: 15px;
            text-align: center; box-shadow: 0 0 40px rgba(212, 175, 55, 0.2);
            transform: translateY(20px); transition: transform 0.3s;
            overflow: hidden; display: flex; flex-direction: column;
            max-height: 85vh;
        }
        .modal-header {
            background: linear-gradient(90deg, #2c3e50, #000);
            padding: 20px; border-bottom: 1px solid #d4af37;
        }
        .modal-title { color: #d4af37; font-size: 22px; font-weight: bold; margin: 0;}
        .modal-subtitle { color: #aaa; font-size: 14px; margin-top: 5px; }
        .modal-body {
            padding: 20px; overflow-y: auto; flex: 1; text-align: left; line-height: 1.6; color: #ddd;
        }
        /* ç¬¬ä¸€å±¤æ¨£å¼ */
        .image-desc-box {
            background: rgba(255,255,255,0.05); padding: 15px;
            border-radius: 8px; margin-bottom: 20px; font-size: 15px;
            border-left: 3px solid #d4af37;
        }
        .category-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px;
        }
        .cat-btn {
            background: transparent; border: 1px solid #555; color: #ccc;
            padding: 10px 5px; border-radius: 8px; cursor: pointer;
            transition: all 0.2s; font-size: 14px;
        }
        .cat-btn:hover { background: #d4af37; color: #000; border-color: #d4af37; }
        /* ç¬¬äºŒå±¤æ¨£å¼ */
        .detail-view { display: none; animation: fadeIn 0.3s; }
        .detail-title {
            color: #f1c40f; font-size: 18px; font-weight: bold; margin-bottom: 10px;
            text-align: center; border-bottom: 1px solid #444; padding-bottom: 10px;
        }
        .detail-content { font-size: 15px; margin-bottom: 20px; }
        .back-btn {
            width: 100%; padding: 10px; background: #444; color: white;
            border: none; border-radius: 8px; cursor: pointer; margin-top: 10px;
        }
        .back-btn:hover { background: #666; }
        .modal-footer { padding: 15px; background: #111; border-top: 1px solid #333; }
        .modal-close {
            background: #d4af37; color: #000; border: none; padding: 10px 40px;
            border-radius: 20px; cursor: pointer; font-weight: bold; font-size: 16px; width: 100%;
        }
        .modal-overlay.active { display: flex; opacity: 1; }
        .modal-overlay.active .modal-content { transform: translateY(0); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="hint" id="statusText">è«‹æº–å‚™é–‹å§‹å„€å¼</div>
    <div class="table-area" id="tableArea"></div>

<div class="controls">
    <select id="categorySelector">
        <option value="general">ğŸ”® ç¶œåˆé‹å‹¢</option>
        <option value="love">â¤ï¸ æ„›æƒ…æƒ…æ„Ÿ</option>
        <option value="work">ğŸ’¼ å·¥ä½œäº‹æ¥­</option>
        <option value="finance">ğŸ’° è²¡å‹™é‡‘éŒ¢</option>
        <option value="academic">ğŸ“ å­¸æ¥­è€ƒè©¦</option>
        <option value="friendship">ğŸ¤ äººéš›é—œä¿‚</option>
        <option value="family">ğŸ  å®¶åº­è¦ªæƒ…</option>
    </select>

    <select id="spreadBasic" onchange="changeSpread('basic')">
        <option value="" disabled selected>ğŸ”° åŸºç¤ç‰Œé™£</option>
        <option value="single">å–®å¼µç‰Œ (æ¯æ—¥æŒ‡å¼•)</option>
        <option value="time">æ™‚é–“ä¹‹æµ (éå»/ç¾åœ¨/æœªä¾†)</option>
	<option value="happiness">å¹¸ç¦æŒ‡æ•¸ (æœ¬æœˆé‹å‹¢)</option>
        <option value="self">è‡ªæˆ‘æ¢ç´¢ (äº†è§£è‡ªå·±çš„å…§å¿ƒ)</option>
	<option value="find_partner">å°‹æ‰¾å°è±¡å åœæ³•</option>
        <option value="choice">äºŒæ“‡ä¸€ (å…©é›£é¸æ“‡)</option>
	<option value="friendship">å‹èª¼å åœ (é›™æ–¹çœ‹æ³•)</option> </select>
    </select>

    <select id="spreadAdv" onchange="changeSpread('adv')">
        <option value="" disabled selected>âœ¨ é€²éšç‰Œé™£</option>
        <option value="hexagram">å…­èŠ’æ˜Ÿ (å…¨æ–¹ä½)</option>
        <option value="love_real">æ„›æƒ…çœŸå¿ƒ (äº†è§£è‡ªå·±å’Œå°æ–¹çš„å¿ƒæ„)</option>
        <option value="lovers_pyramid">æˆ€äººé‡‘å­—å¡” (å…©äººç™¼å±•çš„å¯èƒ½æ€§)</option> 
        <option value="celtic">å…‹çˆ¾ç‰¹åå­— (å°‹æ‰¾å•é¡ŒçœŸæ­£æ‰€åœ¨)</option>
	<option value="future">æœªä¾†ç™¼å±•å åœæ³•</option>
	<option value="karmic">å¡çˆ¾ç±³å…‹ (æ¢è¨è‡ªå·±çš„å‘½é‹)</option>
    </select>
    <button id="btnShuffle" onclick="startRitual()">æ´—ç‰Œ</button>
    <button id="btnSpread" onclick="spreadDeck()" disabled>å±•é–‹</button>
    
    <button id="btnReveal" onclick="startReveal()" style="display:none; border-color: #f1c40f; color: #f1c40f;">é–‹å§‹è§£ç‰Œ</button>
    
    <button id="btnReset" onclick="resetGame()" style="display:none; border-color: #fff; color: #000;">é‡ç½®</button>
</div>

    <div class="modal-overlay" id="meaningModal">
        <div class="modal-content">
		<button class="nav-btn prev" onclick="navigateCard(-1)">&#10094;</button>
   		<button class="nav-btn next" onclick="navigateCard(1)">&#10095;</button>
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">ç‰Œå</div>
                <div class="modal-subtitle" id="modalStatus">æ­£ä½ / é€†ä½</div>
            </div>
            <div class="modal-body">
                <div id="mainView">
                    <div class="image-desc-box">
                        <strong style="color: #d4af37;">ã€ç‰Œé¢åœ–è§£ã€‘</strong><br>
                        <span id="imageDescText">...</span>
                    </div>
                    <p style="text-align: center; color: #aaa; margin-bottom: 10px;">è«‹é¸æ“‡æƒ³äº†è§£çš„é¢å‘ï¼š</p>
                    <div class="category-grid">
                        <button class="cat-btn" onclick="showDetail('character')">ğŸ‘¤ äººç‰©</button>
                        <button class="cat-btn" onclick="showDetail('work')">ğŸ’¼ å·¥ä½œ</button>
                        <button class="cat-btn" onclick="showDetail('love')">â¤ï¸ æ„›æƒ…</button>
                        <button class="cat-btn" onclick="showDetail('friendship')">ğŸ¤ å‹æƒ…</button>
                        <button class="cat-btn" onclick="showDetail('family')">ğŸ  è¦ªæƒ…</button>
                        <button class="cat-btn" onclick="showDetail('academic')">ğŸ“ å­¸æ¥­</button>
                        <button class="cat-btn" onclick="showDetail('finance')">ğŸ’° è²¡å‹™</button>
                    </div>
                    <div class="modal-card-img-container">
                        <p style="margin: 20px 0 10px; color: #666; font-size: 12px;">â–¼ ä¸‹æ»‘æª¢è¦–ç‰Œé¢ â–¼</p>
                        <img id="modalCardImage" src="" class="modal-card-img" alt="ç‰Œé¢åœ–æ¡ˆ">
                    </div>
                </div> <div id="detailView" class="detail-view">
                    <div class="detail-title" id="detailTitle">é¡åˆ¥æ¨™é¡Œ</div>
                    <div class="detail-content" id="detailContent">å…§å®¹...</div>
                    <button class="back-btn" onclick="backToMain()">â¬… è¿”å›é¸å–®</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-close" onclick="closeModal()">é—œé–‰è¦–çª—</button>
            </div>
        </div>
    </div>

<script src="tarot-data.js"></script>
<script>
    // --- è¨­å®šèˆ‡å…¨åŸŸè®Šæ•¸ ---
    const TOTAL_CARDS = 78;
    let currentViewingIndex = 0;
    let cardsDOM = [];
    let isSpread = false;
    let hasDrawn = false;
    let isAnimating = false; 
    let currentResult = null;
    let activeCardData = null;
    let activeIsReversed = false;
    let shuffledDeck = []; 
    let selectedCardsDOM = []; // æš«å­˜å·²é¸æ“‡çš„ç‰Œ

    // --- 1. å®šç¾©ç‰Œé™£è³‡æ–™ ---
    const SPREAD_DATA = {
        'happiness': {
            name: "å¹¸ç¦æŒ‡æ•¸å åœæ³•",
            positions: ["æœ¬é€±é‹ç¨‹", "ä¸‹é€±é‹ç¨‹", "ç¬¬ä¸‰é€±é‹ç¨‹", "ç¬¬å››é€±é‹ç¨‹", "ç¬¬äº”é€±é‹ç¨‹"],
            layout: [{x: -240, y: 0}, {x: -120, y: 0}, {x: 0, y: 0}, {x: 120, y: 0}, {x: 240, y: 0}],
            desc: "é æ¸¬æ•´å€‹æœˆçš„æ¯é€±é‹å‹¢èµ·ä¼ã€‚"
        },
        'single': {
            name: "å–®å¼µç‰Œå åœ",
            positions: ["æ ¸å¿ƒ"],
            layout: [{x: 0, y: 0}],
            desc: "é©åˆç°¡å–®çš„æ˜¯éé¡Œæˆ–æ¯æ—¥é‹å‹¢ã€‚"
        },
        'time': {
            name: "æ™‚é–“ä¹‹æµç‰Œé™£",
            positions: ["éå»çš„ç¶“é©—", "ç¾åœ¨çš„ç‹€æ³", "æœªä¾†çš„é æ¸¬"],
            layout: [{x: -120, y: 0}, {x: 0, y: 0}, {x: 120, y: 0}],
            desc: "æª¢è¦–äº‹æƒ…çš„ä¾†é¾å»è„ˆã€‚"
        },
        'self': {
            name: "è‡ªæˆ‘æ¢ç´¢ç‰Œé™£",
            positions: ["å…§å¿ƒæ·±è™•", "ç²¾ç¥ç”Ÿæ´»", "çŸ¥è­˜é ˜åŸŸ", "æ„Ÿæƒ…ç”Ÿæ´»"],
            layout: [{x: 0, y: 0}, {x: 0, y: -250}, {x: -200, y: 250}, {x: 200, y: 250}],
            desc: "å…¨æ–¹ä½äº†è§£è‡ªå·±çš„èº«å¿ƒéˆç‹€æ…‹ã€‚"
        },
        'find_partner': {
            name: "å°‹æ‰¾å°è±¡å åœæ³•",
            positions: ["ç¾åœ¨çš„å¿ƒæƒ…å’Œè™•å¢ƒ", "å¸Œæœ›è¿½æ±‚çš„é¡å‹", "ä½ ä¸å–œæ­¡çš„é¡å‹", "è©²æ¡å–çš„è¡Œå‹•", "æœªä¾†çš„ç™¼å±•"],
            layout: [{x: 0, y: 0}, {x: -200, y: -200}, {x: 200, y: -200}, {x: -200, y: 200}, {x: 200, y: 200}],
            desc: "å°ˆç‚ºå–®èº«è€…è¨­è¨ˆã€‚"
        },
        'choice': {
            name: "äºŒæ“‡ä¸€ç‰Œé™£",
            positions: ["ç¾æ³", "é¸æ“‡Açš„éç¨‹", "é¸æ“‡Bçš„éç¨‹", "é¸æ“‡Açš„çµæœ", "é¸æ“‡Bçš„çµæœ"],
            layout: [{x: 0, y: 150}, {x: -100, y: 0}, {x: -180, y: -120}, {x: 100, y: 0}, {x: 180, y: -120}],
            desc: "é¢è‡¨æŠ‰æ“‡æ™‚ä½¿ç”¨ã€‚"
        },
        'friendship': {
            name: "å‹èª¼å åœæ³•",
            positions: ["ä½ å°å°æ–¹çš„çœ‹æ³•", "å°æ–¹å°ä½ çš„çœ‹æ³•", "ä½ èªç‚ºç›®å‰é—œä¿‚", "å°æ–¹èªç‚ºç›®å‰é—œä¿‚", "ä½ æœŸæœ›æœªä¾†ç™¼å±•", "å°æ–¹æœŸæœ›æœªä¾†ç™¼å±•"],
            layout: [{x: -120, y: -100}, {x: -120, y: 100}, {x: 0, y: -100}, {x: 0, y: 100}, {x: 120, y: -100}, {x: 120, y: 100}],
            desc: "æ·±åº¦è§£æé›™æ–¹å°é€™æ®µé—œä¿‚çš„çœ‹æ³•ã€‚"
        },
        'celtic': {
            name: "å…‹çˆ¾ç‰¹åå­—ç‰Œé™£",
            positions: ["ç¾æ³", "é˜»ç¤™", "å…§åœ¨", "å¤–åœ¨", "éå»", "æœªä¾†", "è‡ªæˆ‘", "ç’°å¢ƒ", "å¼•å°", "çµæœ"],
            layout: [
                {x: -150, y: 0}, {x: -150, y: 0, rotate: 90}, {x: -150, y: -250}, {x: -150, y: 250}, 
                {x: -250, y: 0}, {x: 0, y: 0}, {x: 180, y: 300}, {x: 180, y: 100}, {x: 180, y: -100}, {x: 180, y: -300}
            ],
            desc: "ç¶“å…¸çš„æ·±åº¦å‰–æç‰Œé™£ã€‚"
        },
        'hexagram': {
            name: "å…­èŠ’æ˜Ÿç‰Œé™£",
            positions: ["éå»", "ç¾åœ¨", "æœªä¾†", "è§£æ±ºæ–¹æ³•", "ç’°å¢ƒ", "é¡˜æœ›", "çµæœ"],
            layout: [{x: 0, y: -200}, {x: 150, y: 80}, {x: -150, y: 80}, {x: 0, y: 200}, {x: -150, y: -80}, {x: 150, y: -80}, {x: 0, y: 0}],
            desc: "å…¨æ–¹ä½æ·±å…¥åˆ†æã€‚"
        },
        'lovers_pyramid': {
            name: "æˆ€äººé‡‘å­—å¡”",
            positions: ["ä½ ", "å°æ–¹", "é—œä¿‚", "æ‰“ç®—", "è¡Œå‹•", "é¡§æ…®", "çµæœ"],
            layout: [{x: 0, y: 220}, {x: -130, y: 120}, {x: 130, y: 120}, {x: 0, y: 20}, {x: -130, y: -80}, {x: 130, y: -80}, {x: 0, y: -180}],
            desc: "é æ¸¬å…©äººç™¼å±•å¯èƒ½æ€§ã€‚"
        },
        'karmic': {
            name: "å¡çˆ¾ç±³å…‹å±•é–‹æ³•",
            positions: ["å®¿å‘½", "å€‹æ€§", "é‡å¤§äº‹ä»¶", "å½±éŸ¿", "ç›®çš„", "å®Œæˆ", "å­¸ç¿’"],
            layout: [{x: 180, y: 180}, {x: 100, y: 180}, {x: -180, y: 180}, {x: -100, y: 180}, {x: 100, y: -150}, {x: -100, y: -150}, {x: 0, y: 0}],
            desc: "æ¢è¨å‘½é‹èˆ‡éˆé­‚ä½¿å‘½ã€‚"
        },
        'future': {
            name: "æœªä¾†ç™¼å±•å åœæ³•",
            positions: ["ç¾æ³", "æ„›æƒ…", "äº‹æ¥­", "è²¡é‹", "æˆå°±", "çµæœ"],
            layout: [{x: 0, y: -250}, {x: -250, y: -100}, {x: 250, y: -100}, {x: -250, y: 100}, {x: 250, y: 100}, {x: 0, y: 250}],
            desc: "åˆ†æäº‹ä»¶ç™¼å±•è„ˆçµ¡ã€‚"
        },
        'love_real': {
            name: "æ„›æƒ…çœŸå¿ƒå åœæ³•",
            positions: ["ä½ çš„çœ‹æ³•", "å°æ–¹çš„çœ‹æ³•", "ä½ çš„å½±éŸ¿", "å°æ–¹çš„å½±éŸ¿", "ä½ çš„å¿ƒæƒ…", "çµæœ", "éšœç¤™", "å°æ–¹å¿ƒæƒ…"],
            layout: [{x: -150, y: -120}, {x: 150, y: -120}, {x: 0, y: -300}, {x: 0, y: -50}, {x: 0, y: 100}, {x: 0, y: 200}, {x: -140, y: 100}, {x: 140, y: 100}],
            desc: "æ·±åº¦å‰–æé›™æ–¹å¿ƒæ„ã€‚"
        }
    };

    let currentSpreadKey = 'single';
    let drawnCount = 0;
    let drawnResults = []; 
    
    // --- åˆ‡æ›é¸å–®é‚è¼¯ ---
    function changeSpread(source) {
        const basicSelect = document.getElementById('spreadBasic');
        const advSelect = document.getElementById('spreadAdv');

        if (source === 'basic') {
            advSelect.value = "";
            currentSpreadKey = basicSelect.value;
        } else if (source === 'adv') {
            basicSelect.value = "";
            currentSpreadKey = advSelect.value;
        }
        resetGameDataOnly();
    }

    // --- åˆå§‹åŒ– ---
    function init() {
        const table = document.getElementById('tableArea');
        table.innerHTML = "";
        cardsDOM = [];
        shuffledDeck = Array.from({length: TOTAL_CARDS}, (_, i) => i);

        for (let i = 0; i < TOTAL_CARDS; i++) {
            const el = document.createElement('div');
            el.className = 'card';
            el.dataset.index = i;
            el.style.setProperty('--tx', '0px');
            el.style.setProperty('--ty', '0px');
            el.style.setProperty('--rot', '0deg');
            el.style.zIndex = i;
            el.innerHTML = `<div class="card-inner"><div class="front"></div><div class="back"></div></div>`;
            el.onclick = () => onCardClick(el);
            table.appendChild(el);
            cardsDOM.push(el);
        }
        
        const spreadInfo = SPREAD_DATA[currentSpreadKey];
        if(spreadInfo) {
             updateStatus(`ç›®å‰æ¨¡å¼ï¼š${spreadInfo.name}ã€‚è«‹å…ˆé¸æ“‡ã€Œå åœé¢å‘ã€ä¸¦é»æ“Šã€Œæ´—ç‰Œã€`);
        } else {
             updateStatus("è«‹é»æ“Šã€Œæ´—ç‰Œã€é–‹å§‹å„€å¼");
        }
    }

    // --- é‡ç½®éŠæˆ²æ•¸æ“š ---
    function resetGameDataOnly() {
        drawnCount = 0;
        drawnResults = [];
        selectedCardsDOM = []; 
        hasDrawn = false;
        isSpread = false;
        init(); 
        document.getElementById('btnShuffle').style.display = 'inline-block';
        document.getElementById('btnSpread').style.display = 'inline-block';
        document.getElementById('btnSpread').disabled = true;
        document.getElementById('btnShuffle').disabled = false;
        document.getElementById('btnReset').style.display = 'none';
        document.getElementById('btnReveal').style.display = 'none';
    }

    // --- æ´—ç‰Œé‚è¼¯ ---
    function internalShuffle() {
        for (let i = shuffledDeck.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [shuffledDeck[i], shuffledDeck[j]] = [shuffledDeck[j], shuffledDeck[i]];
        }
    }

    async function startRitual() {
        document.getElementById('btnShuffle').disabled = true;
        updateStatus("æ­£åœ¨æ‰“äº‚ç‰Œé™£...");
        internalShuffle();
        await animateMessyShuffle();
        updateStatus("æ•´ç†ç‰Œå †...");
        await animateGather();
        updateStatus("åˆ‡ç‰Œ...");
        await animateCutDeck();
        updateStatus("ç‰Œå †å·²æ·¨åŒ–ï¼Œè«‹é»æ“Šã€Œå±•é–‹ã€");
        document.getElementById('btnSpread').disabled = false;
    }

    function animateMessyShuffle() {
        return new Promise(resolve => {
            cardsDOM.forEach(card => {
                const tx = (Math.random() - 0.5) * window.innerWidth * 0.8;
                const ty = (Math.random() - 0.5) * window.innerHeight * 0.6;
                const rot = (Math.random() - 0.5) * 720;
                card.style.setProperty('--tx', tx + 'px');
                card.style.setProperty('--ty', ty + 'px');
                card.style.setProperty('--rot', rot + 'deg');
            });
            setTimeout(resolve, 1000);
        });
    }

    function animateGather() {
        return new Promise(resolve => {
            cardsDOM.forEach((card, index) => {
                card.style.setProperty('--tx', '0px');
                card.style.setProperty('--ty', -index * 0.2 + 'px');
                card.style.setProperty('--rot', '0deg');
                card.style.zIndex = index;
            });
            setTimeout(resolve, 800);
        });
    }
    
    function animateCutDeck() {
        return new Promise(resolve => {
            const cutIndex = Math.floor(TOTAL_CARDS / 2);
            cardsDOM.forEach((card, i) => {
                if(i >= cutIndex) {
                    card.style.setProperty('--tx', '120px');
                    card.style.setProperty('--ty', -i * 0.2 + 'px');
                    card.style.setProperty('--rot', '5deg');
                } else {
                    card.style.setProperty('--tx', '-120px');
                    card.style.setProperty('--ty', -i * 0.2 + 'px');
                    card.style.setProperty('--rot', '-5deg');
                }
            });
            setTimeout(() => {
                cardsDOM.forEach((card, index) => {
                    card.style.setProperty('--tx', '0px');
                    card.style.setProperty('--ty', -index * 0.2 + 'px');
                    card.style.setProperty('--rot', '0deg');
                });
                setTimeout(resolve, 800);
            }, 800);
        });
    }

    function spreadDeck() {
        isSpread = true;
        document.getElementById('btnSpread').disabled = true;
        document.getElementById('btnShuffle').style.display = 'none';
        document.getElementById('btnSpread').style.display = 'none';
        
        const isMobile = window.innerWidth < 600;
        const angleRange = isMobile ? 100 : 140; 
        const radius = isMobile ? 300 : 500; 
        const yOffset = isMobile ? 250 : 350;
        const startAngle = -(angleRange / 2); 
        const step = angleRange / (TOTAL_CARDS - 1);

        cardsDOM.forEach((card, index) => {
            const angle = startAngle + (index * step);
            const radian = angle * (Math.PI / 180);
            const x = radius * Math.sin(radian);
            const y = -radius * Math.cos(radian) + yOffset; 
            
            card.classList.add('spread'); 
            
            card.style.setProperty('--tx', x + 'px');
            card.style.setProperty('--ty', y + 'px');
            card.style.setProperty('--rot', angle + 'deg');
            
            // è¨˜éŒ„æ‰‡å½¢ä½ç½®
            card.dataset.fanTx = x;
            card.dataset.fanTy = y;
            card.dataset.fanRot = angle;

            card.style.transform = `translate(${x}px, ${y}px) rotate(${angle}deg)`;
            card.style.zIndex = index;
        });

        const spreadInfo = SPREAD_DATA[currentSpreadKey];
        updateStatus(`è«‹æ†‘ç›´è¦ºæŠ½å‡ºç¬¬ 1 å¼µç‰Œï¼šã€${spreadInfo.positions[0]}ã€‘`);
    }

    // --- æ ¸å¿ƒï¼šé»æ“ŠæŠ½ç‰Œ (å †ç–Š + ä½ˆé™£) ---
    function onCardClick(card) {
        if (isAnimating) return;

        // 1. å¦‚æœå·²ç¶“ä½ˆé™£å®Œæˆï¼Œé»æ“Šå‰‡æ˜¯é–‹å•Ÿè§£ç‰Œè¦–çª—
        if (hasDrawn && card.classList.contains('drawn')) {
            const resultIndex = parseInt(card.dataset.drawnIndex);
            if (!isNaN(resultIndex)) {
                currentViewingIndex = resultIndex;
                showModal();
            }
            return;
        }

        const spreadInfo = SPREAD_DATA[currentSpreadKey];
        const totalNeeded = spreadInfo.positions.length;

        // 2. é¸ç‰Œéšæ®µ (é‚„æ²’ä½ˆé™£)
        if (isSpread && !hasDrawn) {
            
            // (A) å¦‚æœé»åˆ°å·²ç¶“é¸éçš„ç‰Œ -> å–æ¶ˆé¸æ“‡
            if (selectedCardsDOM.includes(card)) {
                selectedCardsDOM = selectedCardsDOM.filter(c => c !== card);
                card.classList.remove('selected');
                
                // é£›å›åŸæœ¬æ‰‡å½¢ä½ç½®
                card.style.setProperty('--tx', card.dataset.fanTx + 'px');
                card.style.setProperty('--ty', card.dataset.fanTy + 'px');
                card.style.setProperty('--rot', card.dataset.fanRot + 'deg');
                card.style.transform = `translate(${card.dataset.fanTx}px, ${card.dataset.fanTy}px) rotate(${card.dataset.fanRot}deg)`;
                card.style.zIndex = card.dataset.index;
                
                updateStatus(`å·²å–æ¶ˆé¸æ“‡ã€‚ç›®å‰å·²é¸ ${selectedCardsDOM.length} / ${totalNeeded} å¼µ`);
                return;
            }

            // (B) æª¢æŸ¥æ˜¯å¦å·²é¸æ»¿
            if (selectedCardsDOM.length >= totalNeeded) return;

            // (C) åŸ·è¡Œé¸æ“‡ï¼šé£›åˆ°ä¸­é–“å †ç–Š
            selectedCardsDOM.push(card);
            card.classList.add('selected'); 
            
            const randomRot = (Math.random() * 10 - 5); 
            // å¼·åˆ¶è¨­å®š style.transform è¦†è“‹æ‰‡å½¢ä½ç½®ï¼Œé£›åˆ°ç•«é¢ä¸­å¤®ä¸‹æ–¹å †ç–Š
            card.style.transform = `translate(0px, 150px) rotate(${randomRot}deg) scale(1)`;
            card.style.zIndex = 1000 + selectedCardsDOM.length; 
            
            let currentCount = selectedCardsDOM.length;
            if (currentCount < totalNeeded) {
                updateStatus(`å·²é¸æ“‡ ${currentCount} / ${totalNeeded} å¼µï¼Œä¸‹ä¸€å¼µä½ç½®ï¼šã€${spreadInfo.positions[currentCount]}ã€‘`);
            } else {
                // (D) é¸æ»¿äº†ï¼è‡ªå‹•è§¸ç™¼ä½ˆé™£
                updateStatus(`å·²é¸æ»¿ ${totalNeeded} å¼µï¼Œæ­£åœ¨ä½ˆé™£...`);
                setTimeout(performBatchPlacement, 600);
            }
        }
    }

    // --- æ‰¹æ¬¡ä½ˆé™£å‹•ç•« ---
    function performBatchPlacement() {
        isAnimating = true;
        const spreadInfo = SPREAD_DATA[currentSpreadKey];
        
        // 1. å…ˆæŠŠæ²’è¢«é¸åˆ°çš„ç‰Œéš±è—èµ·ä¾†
        cardsDOM.forEach(c => {
            if (!selectedCardsDOM.includes(c)) {
                c.style.transition = "opacity 0.5s";
                c.style.opacity = '0';
                c.style.pointerEvents = 'none';
            }
        });

        // 2. ä¾åºå°‡é¸å¥½çš„ç‰Œé£›åˆ°æŒ‡å®šä½ç½®
        selectedCardsDOM.forEach((card, index) => {
            // å–å¾—å°æ‡‰çš„è³‡æ–™
            const cardIndex = parseInt(card.dataset.index);
            const drawId = shuffledDeck[cardIndex];
            const isReversed = Math.random() < 0.5;
            const currentPosName = spreadInfo.positions[index];
            const currentLayout = spreadInfo.layout[index];
            
            let data = null;
            if (typeof getCardData === 'function') { data = getCardData(drawId); }
            else { data = { name: "è®€å–ä¸­...", id: drawId }; }

            // å„²å­˜çµæœ
            drawnResults.push({
                id: drawId, name: data.name, isReversed: isReversed,
                positionName: currentPosName, index: index
            });

            // è¨­å®š DOM ç‹€æ…‹
            card.dataset.drawnIndex = index;
            card.classList.remove('spread');
            card.classList.remove('selected'); 
            card.classList.add('drawn');       

            // è¨ˆç®—æœ€çµ‚åº§æ¨™
            const isMobile = window.innerWidth < 600;
            const spaceScale = isMobile ? 0.45 : 1;
            // æ‰‹æ©Ÿç‰ˆæ¯”ä¾‹ç¸®å°ï¼Œé¿å…çˆ†ç‰ˆ
            const sizeScale = isMobile ? 0.65 : 1.4;
            
            const finalX = currentLayout.x * spaceScale;
            const finalY = currentLayout.y * spaceScale;
            let rotateDeg = currentLayout.rotate || 0;

            // è¨­å®šå‹•ç•«å»¶é²ï¼Œè®“ç‰Œä¸€å¼µä¸€å¼µé£›éå»
            setTimeout(() => {
                card.style.transform = `translate(calc(-50% + ${finalX}px), calc(-50% + ${finalY}px)) rotate(${rotateDeg}deg) scale(${sizeScale})`;
                card.style.zIndex = 100 + index;
                
                // é å…ˆå¡«å…¥èƒŒé¢å…§å®¹ (ä¿æŒè“‹ç‰Œç‹€æ…‹)
                const backDiv = card.querySelector('.back');
                const imgPath = `images/${drawId}.jpg`;
                backDiv.innerHTML = `
                    <div class="back-img-container">
                        <img src="${imgPath}" style="${isReversed ? 'transform: rotate(180deg)' : ''}" onerror="this.src='https://via.placeholder.com/300x525?text=Card'">
                    </div>
                    <div class="back-text">
                        <div style="font-size:12px; color:#d4af37; margin-bottom:2px;">[${index+1}] ${currentPosName}</div>
                        <div class="card-name-text">${data.name}</div>
                    </div>
                `;
            }, index * 200); 
        });

        // 3. å‹•ç•«çµæŸå¾Œé¡¯ç¤ºæŒ‰éˆ•
        setTimeout(() => {
            updateStatus("ç‰Œé™£å·²å®Œæˆï¼Œè«‹é»æ“Šä¸‹æ–¹ã€Œé–‹å§‹è§£ç‰Œã€");
            document.getElementById('btnReveal').style.display = 'inline-block';
            document.getElementById('btnReset').style.display = 'inline-block';
            hasDrawn = true;
            isAnimating = false;
        }, selectedCardsDOM.length * 200 + 500);
    }

    function startReveal() {
        if (drawnResults.length === 0) return;
        currentViewingIndex = 0;
        showModal();
    }

    function navigateCard(direction) {
        const nextIndex = currentViewingIndex + direction;
        if (nextIndex >= 0 && nextIndex < drawnResults.length) {
            currentViewingIndex = nextIndex;
            showModal();
        }
    }

    // --- è©³ç´°è¦–çª— ---
    function showModal() {
        currentResult = drawnResults[currentViewingIndex];
        
        if(!currentResult) return;
        let data = getCardData(currentResult.id);
        if (!data) return;

        activeCardData = data;
        activeIsReversed = currentResult.isReversed;
        
        const prevBtn = document.querySelector('.nav-btn.prev');
        const nextBtn = document.querySelector('.nav-btn.next');
        if(prevBtn) prevBtn.style.display = (currentViewingIndex === 0) ? 'none' : 'block';
        if(nextBtn) nextBtn.style.display = (currentViewingIndex === drawnResults.length - 1) ? 'none' : 'block';

        document.getElementById('modalTitle').innerHTML = 
            `<span style="font-size:0.6em; color:#d4af37; display:block;">ä½ç½® ${currentResult.index + 1}ï¼š${currentResult.positionName}</span>` + 
            data.name;

        document.getElementById('modalStatus').innerText = activeIsReversed ? "ã€é€†ä½ã€‘ Reversed" : "ã€æ­£ä½ã€‘ Upright";
        document.getElementById('modalStatus').style.color = activeIsReversed ? "#e74c3c" : "#2ecc71";
        document.getElementById('imageDescText').innerText = data.image_desc || "æš«ç„¡åœ–è§£è³‡æ–™";

        const modalImg = document.getElementById('modalCardImage');
        if(modalImg) {
            modalImg.src = `images/${currentResult.id}.jpg`;
            modalImg.style.transform = activeIsReversed ? "rotate(180deg)" : "none";
        }

        const selectedCategory = document.getElementById('categorySelector').value;
        if (activeCardData.categories && activeCardData.categories[selectedCategory]) {
            showDetail(selectedCategory);
            document.getElementById('mainView').style.display = 'none'; 
        } else {
            document.getElementById('mainView').style.display = 'block';
            document.getElementById('detailView').style.display = 'none';
        }
        
        // é€£å‹•æ¡Œé¢çš„ç‰Œ
        document.querySelectorAll('.card').forEach(c => c.style.filter = 'brightness(1)');
        const targetCard = cardsDOM.find(c => parseInt(c.dataset.drawnIndex) === currentViewingIndex);
        if(targetCard) {
            targetCard.style.filter = 'brightness(1.5)';
            targetCard.style.zIndex = 9999;
            if (!targetCard.classList.contains('flipped')) {
                targetCard.classList.add('flipped');
            }
        }

        document.getElementById('meaningModal').classList.add('active');
    }

    function showDetail(categoryKey) {
        if (!activeCardData || !activeCardData.categories || !activeCardData.categories[categoryKey]) {
            alert("æ­¤é …ç›®æš«ç„¡è©³ç´°è³‡æ–™");
            return;
        }
        const catData = activeCardData.categories[categoryKey];
        document.getElementById('detailTitle').innerText = catData.label;
        const content = activeIsReversed ? catData.reversed : catData.upright;
        
        document.getElementById('detailContent').innerHTML = `
            <div style="margin-bottom: 10px; color: #aaa; font-size: 13px;">
                ${activeIsReversed ? "â–¼ é€†ä½æŒ‡å¼•" : "â–² æ­£ä½æŒ‡å¼•"}
            </div>
            <div style="line-height: 1.8; color: #fff;">${content}</div>
        `;
        document.getElementById('mainView').style.display = 'none';
        document.getElementById('detailView').style.display = 'block';
    }

    function backToMain() {
        document.getElementById('detailView').style.display = 'none';
        document.getElementById('mainView').style.display = 'block';
    }

    function closeModal() {
        document.getElementById('meaningModal').classList.remove('active');
    }
    
    document.getElementById('meaningModal').onclick = function(e) {
        if(e.target === this) closeModal();
    }

    function resetGame() {
        location.reload();
    }

    function updateStatus(text) {
        const el = document.getElementById('statusText');
        el.innerText = text;
        el.style.opacity = 1;
    }

    init();
</script>
</body>
</html>